{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-file-import"></i> Import Matches from Text</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> How to use:</h5>
                    <ol>
                        <li>Paste your match data in the text area below</li>
                        <li>The format should include:
                            <ul>
                                <li>Date and time (e.g., "Nov 29, 10:00 AM ET")</li>
                                <li>Team names</li>
                                <li>Probabilities as percentages (e.g., "15%")</li>
                                <li>Odds in American format (e.g., "+600", "-190")</li>
                            </ul>
                        </li>
                        <li>Click "Import Matches" to process</li>
                    </ol>
                    <p class="mb-0"><strong>Example format:</strong></p>
                    <pre class="bg-light p-2 mt-2" style="font-size: 0.9em;">
Nov 29, 10:00 AM ET
Burnley
Burnley
15%
FanDuel
+600
Brentford
Brentford
64%
BetMGM
-190
EPL</pre>
                </div>
                
                <form method="post" class="mt-4" id="importForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="text_data" class="form-label"><strong>Paste Match Data:</strong></label>
                        <textarea 
                            name="text_data" 
                            id="text_data" 
                            class="form-control" 
                            rows="20" 
                            placeholder="Paste your match data here..."
                            style="font-family: monospace; font-size: 0.9em;"
                            required
                        ></textarea>
                        <small class="form-text text-muted">Paste the text containing match information, dates, teams, probabilities, and odds.</small>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="importBtn">
                            <i class="fas fa-file-import"></i> Import Matches
                        </button>
                        <a href="{% url 'matches:match_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Matches
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Duplicate matches (same teams and date) will be skipped automatically</li>
                    <li>Teams will be created automatically if they don't exist</li>
                    <li>Draw probability is calculated automatically (100% - Team A% - Team B%)</li>
                    <li>American odds (+600, -190) are automatically converted to decimal format</li>
                    <li>You'll see success messages and any errors after importing</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Import Status Modal -->
<div class="modal fade" id="importStatusModal" tabindex="-1" aria-labelledby="importStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importStatusModalLabel">
                    <i class="fas fa-file-import"></i> Import Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="importStatusBody">
                <!-- Loading state -->
                <div id="importLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3"><strong>Importing matches...</strong></p>
                    <p class="text-muted">Please wait while we process your data.</p>
                </div>
                
                <!-- Results state -->
                <div id="importResults" style="display: none;">
                    <div id="importSummary" class="mb-4"></div>
                    <div id="importDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{% url 'matches:match_list' %}" class="btn btn-primary" id="viewMatchesBtn" style="display: none;">
                    <i class="fas fa-list"></i> View Matches
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('importForm');
    const importBtn = document.getElementById('importBtn');
    const modal = new bootstrap.Modal(document.getElementById('importStatusModal'));
    const importLoading = document.getElementById('importLoading');
    const importResults = document.getElementById('importResults');
    const importSummary = document.getElementById('importSummary');
    const importDetails = document.getElementById('importDetails');
    const viewMatchesBtn = document.getElementById('viewMatchesBtn');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show modal with loading state
        importLoading.style.display = 'block';
        importResults.style.display = 'none';
        importSummary.innerHTML = '';
        importDetails.innerHTML = '';
        viewMatchesBtn.style.display = 'none';
        modal.show();
        
        // Disable submit button
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
        
        // Get form data
        const formData = new FormData(form);
        
        // Add AJAX header
        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action || window.location.href);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onload = function() {
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Matches';
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    // Hide loading, show results
                    importLoading.style.display = 'none';
                    importResults.style.display = 'block';
                    
                    // Build summary
                    let summaryHTML = '<div class="alert ';
                    if (response.created > 0) {
                        summaryHTML += 'alert-success"><i class="fas fa-check-circle"></i> ';
                        summaryHTML += `<strong>Success!</strong> ${response.message}`;
                    } else if (response.errors.length > 0) {
                        summaryHTML += 'alert-danger"><i class="fas fa-exclamation-circle"></i> ';
                        summaryHTML += `<strong>Import Failed</strong> - No matches were imported due to errors.`;
                    } else {
                        summaryHTML += 'alert-info"><i class="fas fa-info-circle"></i> ';
                        summaryHTML += `<strong>Info:</strong> ${response.message}`;
                    }
                    summaryHTML += '</div>';
                    
                    // Add statistics
                    summaryHTML += '<div class="row text-center mb-3">';
                    summaryHTML += `<div class="col-md-4"><div class="card bg-success text-white"><div class="card-body"><h4>${response.created}</h4><small>Created</small></div></div></div>`;
                    summaryHTML += `<div class="col-md-4"><div class="card bg-warning text-dark"><div class="card-body"><h4>${response.warnings.length}</h4><small>Warnings</small></div></div></div>`;
                    summaryHTML += `<div class="col-md-4"><div class="card bg-danger text-white"><div class="card-body"><h4>${response.errors.length}</h4><small>Errors</small></div></div></div>`;
                    summaryHTML += '</div>';
                    
                    importSummary.innerHTML = summaryHTML;
                    
                    // Build details
                    let detailsHTML = '';
                    
                    // Show warnings if any
                    if (response.warnings.length > 0) {
                        detailsHTML += '<div class="mb-3">';
                        detailsHTML += '<h6><i class="fas fa-exclamation-triangle text-warning"></i> Warnings:</h6>';
                        detailsHTML += '<ul class="list-group">';
                        response.warnings.forEach(function(warning) {
                            detailsHTML += `<li class="list-group-item"><small>${warning}</small></li>`;
                        });
                        if (response.warnings.length === 50) {
                            detailsHTML += '<li class="list-group-item text-muted"><small><em>... and more warnings (showing first 50)</em></small></li>';
                        }
                        detailsHTML += '</ul></div>';
                    }
                    
                    // Show errors if any
                    if (response.errors.length > 0) {
                        detailsHTML += '<div class="mb-3">';
                        detailsHTML += '<h6><i class="fas fa-times-circle text-danger"></i> Errors:</h6>';
                        detailsHTML += '<ul class="list-group">';
                        response.errors.forEach(function(error) {
                            detailsHTML += `<li class="list-group-item text-danger"><small>${error}</small></li>`;
                        });
                        if (response.errors.length === 50) {
                            detailsHTML += '<li class="list-group-item text-muted"><small><em>... and more errors (showing first 50)</em></small></li>';
                        }
                        detailsHTML += '</ul></div>';
                    }
                    
                    if (detailsHTML === '') {
                        detailsHTML = '<p class="text-muted text-center">No warnings or errors.</p>';
                    }
                    
                    importDetails.innerHTML = detailsHTML;
                    
                    // Show view matches button if matches were created
                    if (response.created > 0) {
                        viewMatchesBtn.style.display = 'inline-block';
                    }
                    
                } catch (e) {
                    // Error parsing response
                    importLoading.style.display = 'none';
                    importResults.style.display = 'block';
                    importSummary.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> Could not process the response. Please try again.</div>';
                }
            } else {
                // HTTP error
                importLoading.style.display = 'none';
                importResults.style.display = 'block';
                importSummary.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> Server error occurred. Please try again.</div>';
            }
        };
        
        xhr.onerror = function() {
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Matches';
            importLoading.style.display = 'none';
            importResults.style.display = 'block';
            importSummary.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> Network error occurred. Please check your connection and try again.</div>';
        };
        
        xhr.send(formData);
    });
});
</script>
{% endblock %}

