# Generated by Django 5.2.6 on 2025-11-24 06:52

from django.db import migrations, models


def convert_prediction_values_forward(apps, schema_editor):
    """
    Convert prediction values from old format to new format:
    Old: '1' = Team A, '3' = Team B, '0' = Draw
    New: '3' = Team A, '0' = Team B, '1' = Draw
    """
    Prediction = apps.get_model('predictions', 'Prediction')
    
    # Conversion mapping
    value_map = {
        '1': '3',  # Old Team A → New Team A
        '3': '0',  # Old Team B → New Team B
        '0': '1',  # Old Draw → New Draw
    }
    
    # Convert all prediction fields
    for pred in Prediction.objects.all():
        if pred.baseline in value_map:
            pred.baseline = value_map[pred.baseline]
        if pred.profitable in value_map:
            pred.profitable = value_map[pred.profitable]
        if pred.balanced in value_map:
            pred.balanced = value_map[pred.balanced]
        if pred.ai_baseline and pred.ai_baseline in value_map:
            pred.ai_baseline = value_map[pred.ai_baseline]
        if pred.ai_profitable and pred.ai_profitable in value_map:
            pred.ai_profitable = value_map[pred.ai_profitable]
        if pred.ai_balanced and pred.ai_balanced in value_map:
            pred.ai_balanced = value_map[pred.ai_balanced]
        pred.save()


def convert_prediction_values_backward(apps, schema_editor):
    """
    Reverse conversion (for rollback):
    New: '3' = Team A, '0' = Team B, '1' = Draw
    Old: '1' = Team A, '3' = Team B, '0' = Draw
    """
    Prediction = apps.get_model('predictions', 'Prediction')
    
    # Reverse conversion mapping
    value_map = {
        '3': '1',  # New Team A → Old Team A
        '0': '3',  # New Team B → Old Team B
        '1': '0',  # New Draw → Old Draw
    }
    
    # Convert all prediction fields back
    for pred in Prediction.objects.all():
        if pred.baseline in value_map:
            pred.baseline = value_map[pred.baseline]
        if pred.profitable in value_map:
            pred.profitable = value_map[pred.profitable]
        if pred.balanced in value_map:
            pred.balanced = value_map[pred.balanced]
        if pred.ai_baseline and pred.ai_baseline in value_map:
            pred.ai_baseline = value_map[pred.ai_baseline]
        if pred.ai_profitable and pred.ai_profitable in value_map:
            pred.ai_profitable = value_map[pred.ai_profitable]
        if pred.ai_balanced and pred.ai_balanced in value_map:
            pred.ai_balanced = value_map[pred.ai_balanced]
        pred.save()


class Migration(migrations.Migration):

    dependencies = [
        ('predictions', '0001_initial'),
    ]

    operations = [
        # First convert data
        migrations.RunPython(convert_prediction_values_forward, convert_prediction_values_backward),
        # Then alter field choices
        migrations.AlterField(
            model_name='prediction',
            name='ai_balanced',
            field=models.CharField(blank=True, choices=[('3', 'Team A'), ('1', 'Draw'), ('0', 'Team B')], help_text='AI-generated balanced prediction', max_length=1, null=True),
        ),
        migrations.AlterField(
            model_name='prediction',
            name='ai_baseline',
            field=models.CharField(blank=True, choices=[('3', 'Team A'), ('1', 'Draw'), ('0', 'Team B')], help_text='AI-generated baseline prediction', max_length=1, null=True),
        ),
        migrations.AlterField(
            model_name='prediction',
            name='ai_profitable',
            field=models.CharField(blank=True, choices=[('3', 'Team A'), ('1', 'Draw'), ('0', 'Team B')], help_text='AI-generated profitable prediction', max_length=1, null=True),
        ),
        migrations.AlterField(
            model_name='prediction',
            name='balanced',
            field=models.CharField(choices=[('3', 'Team A'), ('1', 'Draw'), ('0', 'Team B')], help_text='Balanced prediction: Combine probability + odds', max_length=1),
        ),
        migrations.AlterField(
            model_name='prediction',
            name='baseline',
            field=models.CharField(choices=[('3', 'Team A'), ('1', 'Draw'), ('0', 'Team B')], help_text='Baseline prediction: Higher probability wins', max_length=1),
        ),
        migrations.AlterField(
            model_name='prediction',
            name='profitable',
            field=models.CharField(choices=[('3', 'Team A'), ('1', 'Draw'), ('0', 'Team B')], help_text='Profitable prediction: Compare implied probability vs odds', max_length=1),
        ),
    ]
